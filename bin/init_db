#!/usr/bin/env node

'use strict';

const config = require('config');
const mongoose = require('mongoose');

const mongoURI = config.get('mongoURI');
const tasklogs = ['task', 'twit_new', 'twit_tomorrow', 'delete'].map(function (name) {
  return {
    name,
    log: 'initialized',
    level: 1,
    time: new Date(),
    elapsedTime: 0
  };
});

require('../db/tasklog');
const db = mongoose.createConnection(mongoURI);
const dbClose = function () {
  db.close();
};
db.on('error', function (err) {
  throw err;
});
db.once('open', function () {
  const mTasklog = db.model('Tasklog');
  return Promise.all(tasklogs.map(function (tasklog) {
    return new Promise(function (resolve, reject) {
      mTasklog.findOrCreate({
        name: tasklog.name
      }, tasklog, function (err, event, created) {
        if (err) {
          reject(err);
        } else {
          resolve(created);
        }
      });
    });
  })).then(function () {
    console.log('msg: db init success');
  }).catch(function (err) {
    console.log('err: ' + err.stack);
  }).then(dbClose, dbClose);
});

#!/usr/bin/env node

'use strict';

const apidoc = require('apidoc');
const config = require('config');
const fs = require('fs');
const glob = require('glob');
const hljs = require('highlight.js');
const mkdirp = require('mkdirp');
const path = require('path');
const pug = require('pug');

const createDoc = src => {
  const doc = apidoc.createDoc({
    debug: false,
    parse: true,
    silent: true,
    src
  });
  doc.data = JSON.parse(doc.data);
  doc.project = JSON.parse(doc.project);
  doc.list = {};
  doc.data.map(api => {
    // list
    if (!doc.list[api.group]) {
      doc.list[api.group] = [];
    }
    doc.list[api.group].push(api.title);
    // examples
    api.success.examples = api.success.examples.map(example => {
      example.content = hljs.highlight(example.type, example.content, true).value;
      return example;
    });
    return api;
  });
  return doc;
};

const dest = 'views';
const doc = createDoc('./routes/api1');

mkdirp.sync(dest);

glob.sync('src/pug/*.pug').forEach(file => {
  const compile = pug.compileFile(file);
  const html = compile({
    doc,
    site: config.get('site')
  });
  fs.writeFile(path.join(dest, `${file.slice(file.lastIndexOf('/') + 1, file.lastIndexOf('.'))}.html`), html);
});
